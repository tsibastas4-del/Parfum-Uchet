<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚ú® PerfumeFlow Pro v18.1 (Smart Fix)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CSS VARIABLES & THEMES --- */
        :root {
            /* Light Theme Defaults */
            --primary: #4F46E5; 
            --primary-hover: #4338ca;
            --secondary: #10B981; 
            --danger: #EF4444; 
            --warning: #F59E0B; 
            
            --bg-body: #F3F4F6;
            --bg-card: #FFFFFF;
            --bg-input: #F9FAFB;
            
            --text-main: #1F2937;
            --text-muted: #6B7280;
            
            --border: #E5E7EB;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* DARK MODE OVERRIDES */
        body.dark-mode {
            --primary: #6366f1;
            --primary-hover: #818cf8;
            
            --bg-body: #111827; 
            --bg-card: #1F2937; 
            --bg-input: #374151; 
            
            --text-main: #F3F4F6; 
            --text-muted: #9CA3AF; 
            
            --border: #374151; 
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding-top: 70px; 
            padding-bottom: 70px; 
            -webkit-font-smoothing: antialiased;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- NAVIGATION --- */
        .navbar {
            background-color: var(--bg-card);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 1000;
            border-bottom: 1px solid var(--border);
            transition: background-color 0.3s;
        }

        .navbar-brand {
            font-size: 1.15rem;
            font-weight: 800;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1; 
        }

        .theme-toggle {
            background: transparent !important;
            border: 1px solid var(--border) !important;
            color: var(--text-muted);
            width: 36px !important;
            height: 36px !important;
            padding: 0 !important;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50% !important;
            margin-left: 10px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0; 
        }
        
        .theme-toggle i { font-size: 1rem; }

        .navbar-links {
            display: flex;
            gap: 5px;
            overflow-x: auto; 
            white-space: nowrap;
            padding-bottom: 0;
            -ms-overflow-style: none;  
            scrollbar-width: none;  
        }
        .navbar-links::-webkit-scrollbar { display: none; }

        .nav-btn {
            background: transparent;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-btn:hover { background-color: var(--bg-body); color: var(--primary); }
        .nav-btn.active { background-color: rgba(79, 70, 229, 0.1); color: var(--primary); }

        /* --- LAYOUT & CARDS --- */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .content-section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
            transition: background-color 0.3s, border-color 0.3s;
        }

        h1, h2, h3 { margin-top: 0; color: var(--text-main); }
        h2 { font-size: 1.4rem; margin-bottom: 20px; border-bottom: 2px solid var(--bg-body); padding-bottom: 10px; }
        h3 { font-size: 1.1rem; }

        /* --- FORMS --- */
        .grid-3-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .grid-2-col { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; } 

        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: var(--text-muted); }
        
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.3s, color 0.3s;
            background-color: var(--bg-input);
            color: var(--text-main);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            background-color: var(--bg-card);
        }

        /* --- BUTTONS --- */
        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button:active { transform: scale(0.98); }
        
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-success { background-color: var(--secondary); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-warning { background-color: var(--warning); color: white; }
        
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; width: auto; display: inline-flex; }

        /* --- TABLES --- */
        .table-responsive { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        
        th { background-color: var(--bg-input); text-align: left; padding: 12px 15px; font-size: 0.85rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        td { padding: 12px 15px; border-top: 1px solid var(--border); font-size: 0.95rem; color: var(--text-main); }
        tr:hover td { background-color: var(--bg-input); }
        
        .text-right { text-align: right; }
        .text-bold { font-weight: 700; }
        .text-success { color: var(--secondary); }
        .text-danger { color: var(--danger); }

        /* --- TOAST --- */
        #toast-container { position: fixed; bottom: 80px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            background: var(--bg-card);
            color: var(--text-main);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
            border-left: 5px solid var(--primary);
            animation: slideIn 0.3s ease-out;
            min-width: 250px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toast.success { border-left-color: var(--secondary); }
        .toast.error { border-left-color: var(--danger); }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* --- DASHBOARD WIDGETS --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, var(--primary), var(--primary-hover)); color: white; padding: 15px; border-radius: 12px; box-shadow: var(--shadow); }
        .stat-card.green { background: linear-gradient(135deg, var(--secondary), #059669); }
        .stat-card.danger { background: linear-gradient(135deg, var(--danger), #CC1F1F); } 
        .stat-card h3 { color: rgba(255,255,255,0.8); font-size: 0.8rem; margin-bottom: 5px; font-weight: 500; }
        .stat-card .value { font-size: 1.5rem; font-weight: 800; }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(4px); animation: fadeIn 0.2s; }
        .modal-content { background-color: var(--bg-card); margin: 5% auto; padding: 0; border-radius: 12px; width: 95%; max-width: 500px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3); overflow: hidden; color: var(--text-main); }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border); background: var(--bg-input); display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; }
        .receipt-total { font-size: 1.5rem; font-weight: 800; text-align: right; color: var(--primary); margin-top: 15px; border-top: 2px dashed var(--border); padding-top: 15px; }
        .modal.active { display: block; }

        @media print {
            body * { visibility: hidden; }
            .modal.active, .modal.active * { visibility: visible; }
            .modal { position: absolute; left: 0; top: 0; background: white; color: black; }
            .no-print { display: none; }
            .modal-content { box-shadow: none; border: none; }
        }

        /* --- TASK STYLES --- */
        .task-item {
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.2s;
        }

        .task-item.completed { border-left: 5px solid var(--secondary); opacity: 0.7; }
        .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid var(--border); }
        .task-title { font-weight: 700; font-size: 1.1rem; color: var(--primary); }
        .task-details { font-size: 0.9rem; color: var(--text-muted); line-height: 1.6; }
        .task-details strong { color: var(--text-main); font-weight: 600; }
        .task-comment { margin-top: 10px; padding: 8px; background: rgba(245, 158, 11, 0.1); border-left: 3px solid var(--warning); border-radius: 4px; font-style: italic; color: var(--text-main); }
        
        /* Barcode Scanner & Parser */
        .scanner-box { background: rgba(245, 158, 11, 0.1); border: 1px solid var(--warning); padding: 15px; border-radius: 8px; margin-bottom: 15px; color: var(--text-main); }
        
        /* Parser Box Specifics */
        .parser-area {
            background: var(--bg-input);
            border: 2px dashed var(--primary);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .parser-area textarea {
            border: none;
            background: transparent;
            resize: vertical;
            min-height: 60px;
        }

        /* Mobile specific adjustments */
        @media (max-width: 768px) {
            .navbar-links { position: fixed; bottom: 0; left: 0; right: 0; top: auto; background: var(--bg-card); border-top: 1px solid var(--border); padding: 8px; justify-content: space-between; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
            .nav-btn { flex-direction: column; font-size: 0.65rem; gap: 4px; padding: 6px; width: 16%; text-align: center; border-radius: 6px; }
            .nav-btn i { font-size: 1.1rem; }
            .container { padding-bottom: 90px; } 
            .navbar { padding: 0 15px; height: 55px; }
            .navbar-brand { font-size: 1rem; }
            .theme-toggle { position: static; width: 34px !important; height: 34px !important; margin-left: auto; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="navbar-brand">
            <i class="fa-solid fa-spray-can-sparkles"></i> PerfumeFlow
        </div>
        <button class="theme-toggle" onclick="toggleTheme()" title="–ó–º—ñ–Ω–∏—Ç–∏ —Ç–µ–º—É">
            <i id="theme-icon" class="fa-solid fa-moon"></i>
        </button>

        <div class="navbar-links">
            <button class="nav-btn active" onclick="showSection('dashboard', this)"><i class="fa-solid fa-chart-pie"></i> –ì–æ–ª–æ–≤–Ω–∞</button>
            <button class="nav-btn" onclick="showSection('input-form', this)"><i class="fa-solid fa-cart-plus"></i> –ü—Ä–æ–¥–∞–∂</button>
            <button class="nav-btn" onclick="showSection('multi-calculator', this)"><i class="fa-solid fa-list-check"></i> –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
            <button class="nav-btn" onclick="showSection('transactions', this)"><i class="fa-solid fa-clock-rotate-left"></i> –Ü—Å—Ç–æ—Ä—ñ—è</button>
            <button class="nav-btn" onclick="showSection('tasks', this)"><i class="fa-solid fa-clipboard-list"></i> –ó–∞–¥–∞—á—ñ</button>
            <button class="nav-btn" onclick="showSection('admin-panel', this)"><i class="fa-solid fa-gears"></i> –ê–¥–º—ñ–Ω–∫–∞</button>
        </div>
    </nav>

    <div id="toast-container"></div>

    <div class="container">

        <section id="dashboard" class="content-section active">
            <h2>üëã –í—ñ—Ç–∞—î–º–æ! –û–≥–ª—è–¥ –∑–∞ —Å—å–æ–≥–æ–¥–Ω—ñ</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>–í–∏—Ä—É—á–∫–∞ —Å—å–æ–≥–æ–¥–Ω—ñ</h3>
                    <div class="value" id="dash-revenue">0 ‚Ç¥</div>
                </div>
                <div class="stat-card green">
                    <h3>–ü—Ä–∏–±—É—Ç–æ–∫ —Å—å–æ–≥–æ–¥–Ω—ñ</h3>
                    <div class="value" id="dash-profit">0 ‚Ç¥</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #F59E0B, #D97706);">
                    <h3>–ü—Ä–æ–¥–∞–∂—ñ–≤</h3>
                    <div class="value" id="dash-count">0</div>
                </div>
                <div class="stat-card danger" id="dash-low-stock-count">
                    <h3>–ù–∏–∑—å–∫–∏–π –ó–∞–ø–∞—Å</h3>
                    <div class="value" id="dash-low-stock-count-value">0</div>
                </div>
            </div>
            <div class="card">
                <h3><i class="fa-solid fa-trophy"></i> –¢–æ–ø-5 –ü–æ–ø—É–ª—è—Ä–Ω–∏—Ö –ê—Ä–æ–º–∞—Ç—ñ–≤ (–∑–∞ –æ–±'—î–º–æ–º)</h3>
                <div class="table-responsive">
                    <table id="top-products-table">
                        <thead><tr><th>#</th><th>–ù–∞–∑–≤–∞ –ü–∞—Ä—Ñ—É–º—É</th><th class="text-right">–ü—Ä–æ–¥–∞–Ω–æ</th><th class="text-right">–í–∏—Ä—É—á–∫–∞</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="card">
                <h3><i class="fa-solid fa-bolt"></i> –®–≤–∏–¥–∫—ñ –¥—ñ—ó</h3>
                <div class="grid-2-col">
                    <button class="btn-primary" onclick="showSection('input-form', document.querySelectorAll('.nav-btn')[1])"><i class="fa-solid fa-plus"></i> –ù–æ–≤–∏–π –ø—Ä–æ–¥–∞–∂</button>
                    <button class="btn-success" onclick="showSection('tasks', document.querySelectorAll('.nav-btn')[4])"><i class="fa-solid fa-clipboard-list"></i> –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –ó–∞–¥–∞—á—ñ</button>
                </div>
            </div>
        </section>

        <section id="tasks" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-clipboard-list"></i> –°–ø–∏—Å–æ–∫ –ó–∞–≤–¥–∞–Ω—å</h2>
                <div id="tasks-list-container" style="margin-top: 20px;"></div>
            </div>
        </section>
        
        <section id="input-form" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-bottle-droplet"></i> –®–≤–∏–¥–∫–∏–π –ø—Ä–æ–¥–∞–∂</h2>
                
                <div class="parser-area">
                    <label style="color: var(--primary);"><i class="fa-solid fa-wand-magic-sparkles"></i> –£–º–Ω–∞—è –≤—Å—Ç–∞–≤–∫–∞ (OLX, Viber, –∞–±–æ –Ω–∞–∑–≤–∞ –ø–∞—Ä—Ñ—É–º—É)</label>
                    <textarea id="pasteArea" placeholder="–í—Å—Ç–∞–≤—Ç–µ —Ç–µ–∫—Å—Ç —Å—é–¥–∏ (–Ω–∞–ø—Ä: '–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è Sauvage 100–º–ª 0661234567 –ö–∏—ó–≤ 5')..." rows="2"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 5px;">
                         <button class="btn-sm btn-primary" onclick="parseOrderText()">ü™Ñ –†–æ–∑—ñ–±—Ä–∞—Ç–∏ —Ç–µ–∫—Å—Ç</button>
                         <button class="btn-sm btn-warning" onclick="document.getElementById('pasteArea').value=''">üóë –û—á–∏—Å—Ç–∏—Ç–∏</button>
                    </div>
                </div>

                <div class="grid-3-col" style="margin-bottom: 15px;">
                    <div><label>–ù–∞—Ü—ñ–Ω–∫–∞</label><select id="saleMarkupTierSingle"></select></div>
                    <div><label>–î–∂–µ—Ä–µ–ª–æ</label><select id="saleSourceSingle"></select></div>
                    <div><label>–ö–ª—ñ—î–Ω—Ç (–æ–ø—Ü—ñ–π–Ω–æ)</label><input type="text" id="clientNameSingle" placeholder="–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è..." list="clientList"></div>
                </div>
                
                <h3 style="margin-top: 20px;"><i class="fa-solid fa-truck-moving"></i> –†–µ–∫–≤—ñ–∑–∏—Ç–∏ (–¥–ª—è –ó–∞–¥–∞—á)</h3>
                <div class="grid-2-col" style="margin-bottom: 15px;">
                    <div><label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É</label><input type="text" id="phoneSingle" placeholder="+380..."></div>
                    <div><label>–ü–Ü–ë (–ø–æ–≤–Ω—ñ—Å—Ç—é)</label><input type="text" id="fullNameSingle" placeholder="–Ü–≤–∞–Ω–æ–≤ –Ü–≤–∞–Ω..."></div>
                    <div><label>–ú—ñ—Å—Ç–æ</label><input type="text" id="citySingle" placeholder="–ù–∞–ø—Ä: –ö–∏—ó–≤"></div>
                    <div><label>–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–ü</label><input type="text" id="postOfficeSingle" placeholder="‚ÑñX –∞–±–æ –ê–¥—Ä–µ—Å–∞"></div>
                </div>
                <label>–ö–æ–º–µ–Ω—Ç–∞—Ä –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</label>
                <textarea id="commentsSingle" rows="2" placeholder="–ù–∞–ø—Ä: –°–∫–∏–Ω—É—Ç–∏ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏ –Ω–∞ –í–∞–π–±–µ—Ä..." style="margin-bottom: 20px;"></textarea>
                <label>–ù–∞–∑–≤–∞ –ü–∞—Ä—Ñ—É–º—É</label>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="perfumeName" list="perfumeList" placeholder="–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É...">
                </div>

                <label>–û–±'—î–º (–º–ª)</label>
                <select id="flaconVolume" style="margin-bottom: 20px;"></select>
                <button class="btn-primary" onclick="addSale()"><i class="fa-solid fa-check"></i> –ó–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –ü—Ä–æ–¥–∞–∂</button>
            </div>
        </section>

        <section id="multi-calculator" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-basket-shopping"></i> –ö–æ—à–∏–∫ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</h2>
                <div class="grid-3-col" style="margin-bottom: 15px;">
                     <div><label>–ù–∞—Ü—ñ–Ω–∫–∞</label><select id="saleMarkupTierOrder"></select></div>
                     <div><label>–î–∂–µ—Ä–µ–ª–æ</label><select id="saleSourceOrder"></select></div>
                     <div><label>–ö–ª—ñ—î–Ω—Ç</label><input type="text" id="clientNameOrder" placeholder="–Ü–º'—è –∫–ª—ñ—î–Ω—Ç–∞" list="clientList"></div>
                </div>
                
                <h3 style="margin-top: 20px;"><i class="fa-solid fa-truck-moving"></i> –†–µ–∫–≤—ñ–∑–∏—Ç–∏ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</h3>
                <div class="grid-2-col" style="margin-bottom: 15px;">
                    <div><label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω—É</label><input type="text" id="phoneOrder" placeholder="+380..."></div>
                    <div><label>–ü–Ü–ë (–ø–æ–≤–Ω—ñ—Å—Ç—é)</label><input type="text" id="fullNameOrder" placeholder="–Ü–≤–∞–Ω–æ–≤ –Ü–≤–∞–Ω..."></div>
                    <div><label>–ú—ñ—Å—Ç–æ</label><input type="text" id="cityOrder" placeholder="–ù–∞–ø—Ä: –ö–∏—ó–≤"></div>
                    <div><label>–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–ü</label><input type="text" id="postOfficeOrder" placeholder="‚ÑñX –∞–±–æ –ê–¥—Ä–µ—Å–∞"></div>
                </div>
                <label>–ö–æ–º–µ–Ω—Ç–∞—Ä –¥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</label>
                <textarea id="commentsOrder" rows="2" placeholder="–ù–∞–ø—Ä: –°–∫–∏–Ω—É—Ç–∏ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏ –Ω–∞ –í–∞–π–±–µ—Ä..." style="margin-bottom: 20px;"></textarea>
                <div style="background: var(--bg-input); padding: 15px; border-radius: 8px; border: 1px dashed var(--border); margin-bottom: 15px;">
                    <div class="grid-2-col">
                        <div><label>–ü–∞—Ä—Ñ—É–º</label><input type="text" id="orderPerfumeName" list="perfumeList"></div>
                        <div><label>–û–±'—î–º</label><select id="orderFlaconVolume"></select></div>
                    </div>
                    <button class="btn-warning" style="margin-top: 10px;" onclick="addItemToOrder()"><i class="fa-solid fa-plus-circle"></i> –î–æ–¥–∞—Ç–∏ –ø–æ–∑–∏—Ü—ñ—é</button>
                </div>

                <div class="table-responsive">
                    <table id="order-list-table">
                        <thead><tr><th>–ü–∞—Ä—Ñ—É–º</th><th class="text-right">–û–±'—î–º</th><th class="text-right">–¶—ñ–Ω–∞</th><th class="text-right">–î—ñ—è</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div id="orderTotalSection" style="margin: 20px 0; font-size: 1.2rem; font-weight: bold; text-align: right; color: var(--primary);"></div>
                
                <h3 style="margin-top: 20px;"><i class="fa-solid fa-copy"></i> –¢–µ–∫—Å—Ç –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è (–¥–ª—è –ö–ª—ñ—î–Ω—Ç–∞)</h3>
                <textarea id="orderSummaryOutput" rows="8" readonly placeholder="–¢–µ–∫—Å—Ç –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑'—è–≤–∏—Ç—å—Å—è —Ç—É—Ç..." style="margin-bottom: 10px;"></textarea>
                <button class="btn-warning" onclick="copyOrderSummary()"><i class="fa-solid fa-copy"></i> –ö–æ–ø—ñ—é–≤–∞—Ç–∏ —Ç–µ–∫—Å—Ç</button>
                <label>–ù–æ–º–µ—Ä –¢–¢–ù (–æ–ø—Ü—ñ–π–Ω–æ)</label>
                <input type="text" id="ttnNumberOrder" placeholder="–ù–æ–º–µ—Ä –¢–¢–ù" style="margin-bottom: 20px;">
                
                <div class="grid-2-col" style="margin-top: 20px;">
                    <button class="btn-success" onclick="processOrder()" id="processOrderBtn"><i class="fa-solid fa-cash-register"></i> –û—Ñ–æ—Ä–º–∏—Ç–∏</button>
                    <button class="btn-danger" onclick="clearOrder()"><i class="fa-solid fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç–∏</button>
                </div>
            </div>
        </section>

        <section id="report" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-chart-line"></i> –ó–≤—ñ—Ç–Ω—ñ—Å—Ç—å</h2>
                <div class="grid-2-col" style="margin-bottom: 15px;">
                    <div><label>–ó –¥–∞—Ç–∏</label><input type="date" id="startDate"></div>
                    <div><label>–ü–æ –¥–∞—Ç—É</label><input type="date" id="endDate"></div>
                </div>
                <button class="btn-primary" onclick="generateReport()"><i class="fa-solid fa-filter"></i> –°—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –ó–≤—ñ—Ç</button>
                <div id="reportOutput" style="margin-top: 20px;"></div>
            </div>
        </section>

        <section id="transactions" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-history"></i> –Ü—Å—Ç–æ—Ä—ñ—è –ü—Ä–æ–¥–∞–∂—ñ–≤</h2>
                <div class="grid-3-col" style="margin-bottom: 15px;">
                    <div><input type="text" id="transactionSearch" onkeyup="renderTransactionHistory()" placeholder="üîç –ü–æ—à—É–∫..."></div>
                    <div><select id="historyFilterSource" onchange="renderTransactionHistory()"></select></div>
                    <div><input type="date" id="historyStartDate" onchange="renderTransactionHistory()"></div>
                </div>

                <div class="table-responsive">
                    <table id="transaction-history-table">
                        <thead><tr><th>–î–∞—Ç–∞</th><th>–ö–ª—ñ—î–Ω—Ç</th><th>–î–∂–µ—Ä–µ–ª–æ</th><th>–¢–¢–ù</th><th>–ü–∞—Ä—Ñ—É–º</th><th class="text-right">–°—É–º–∞</th><th class="text-right">–ü—Ä–∏–±—É—Ç–æ–∫</th><th class="text-right">–î—ñ—è</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <p id="transactionSummary" style="margin-top: 15px; font-weight: 600; text-align: right;"></p>
            </div>
        </section>

        <section id="client-crm" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-users"></i> CRM –ö–ª—ñ—î–Ω—Ç—ñ–≤</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <input type="text" id="clientSearchInput" list="clientList" placeholder="–í–≤–µ–¥—ñ—Ç—å —ñ–º'—è –∫–ª—ñ—î–Ω—Ç–∞...">
                    <button class="btn-primary" style="width: auto;" onclick="showClientHistory()"><i class="fa-solid fa-search"></i> –ó–Ω–∞–π—Ç–∏</button>
                </div>
                <div id="clientCrmSummary"></div>
                <div class="table-responsive">
                    <table id="client-history-table">
                        <thead><tr><th>–î–∞—Ç–∞</th><th>–ü–∞—Ä—Ñ—É–º</th><th class="text-right">–°—É–º–∞</th><th class="text-right">–ü—Ä–∏–±—É—Ç–æ–∫</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="admin-panel" class="content-section">
            <div class="grid-2-col" style="margin-bottom: 20px;">
                <button class="btn-primary" onclick="showSection('report', null)">üìä –§—ñ–Ω–∞–Ω—Å–æ–≤—ñ –∑–≤—ñ—Ç–∏</button>
                <button class="btn-primary" onclick="showSection('client-crm', null)">üë• –ë–∞–∑–∞ –∫–ª—ñ—î–Ω—Ç—ñ–≤ (CRM)</button>
                <button class="btn-primary" onclick="showSection('expenses', null)">üí∏ –î–æ–¥–∞—Ç–∏ –í–∏—Ç—Ä–∞—Ç—É</button>
                <button class="btn-primary" onclick="showSection('calculator', null)">üßÆ –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ü—ñ–Ω–∏</button>
            </div>
            
            <div class="card">
                <h2><i class="fa-solid fa-warehouse"></i> –°–∫–ª–∞–¥—Å—å–∫–∏–π –æ–±–ª—ñ–∫</h2>
                <div class="scanner-box">
                    <label>üëã –°–∫–∞–Ω—É–≤–∞—Ç–∏ –®—Ç—Ä–∏—Ö-–∫–æ–¥ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è **500 –º–ª** (–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ)</label>
                    <input type="text" id="inventoryBarcodeScan" placeholder="–ù–∞–≤–µ–¥—ñ—Ç—å —Å–∫–∞–Ω–µ—Ä..." onchange="scanBarcodeForStock(this.value); this.value='';" onkeydown="if(event.key === 'Enter'){ event.preventDefault(); scanBarcodeForStock(this.value); this.value=''; return false; }">
                </div>
                
                <h3 style="margin-top: 20px;"><i class="fa-solid fa-plus-square"></i> –î–æ–¥–∞—Ç–∏/–°–ø–∏—Å–∞—Ç–∏ (–í—Ä—É—á–Ω—É)</h3>
                <div class="grid-2-col" style="margin-bottom: 15px;">
                    <div><label>–ü–∞—Ä—Ñ—É–º</label><input type="text" id="inventoryPerfumeName" list="perfumeList"></div>
                    <div><label>–û–±'—î–º (–º–ª)</label><input type="number" id="inventoryVolume" placeholder="–ù–∞–ø—Ä: 500"></div>
                </div>
                <button class="btn-primary" onclick="addStock()"><i class="fa-solid fa-plus-square"></i> –î–æ–¥–∞—Ç–∏ –ó–∞–ø–∞—Å</button>
                
                <h4 style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px;">–ü–æ—Ç–æ—á–Ω—ñ –∑–∞–ª–∏—à–∫–∏:</h4>
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table id="inventory-list-table">
                        <thead><tr><th>–ù–∞–∑–≤–∞</th><th class="text-right">–ó–∞–ª–∏—à–æ–∫ (–º–ª)</th><th class="text-right">–î—ñ—è</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fa-solid fa-file-invoice"></i> –ü—Ä–∞–π—Å-–ª–∏—Å—Ç –¥–ª—è –∫–ª—ñ—î–Ω—Ç—ñ–≤ (–¶—ñ–Ω–∞ –∑–∞ –º–ª)</h3>
                <label>–í–∏–±–µ—Ä—ñ—Ç—å –Ω–∞—Ü—ñ–Ω–∫—É –¥–ª—è –ø—Ä–∞–π—Å—É:</label>
                <select id="priceListMarkup"></select>
                <button class="btn-warning" style="margin-top: 10px;" onclick="generatePriceList()"><i class="fa-solid fa-list-ul"></i> –°—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ —Ç–∞ —Å–∫–æ–ø—ñ—é–≤–∞—Ç–∏</button>
                <textarea id="priceListOutput" rows="10" readonly placeholder="–¢—É—Ç –±—É–¥–µ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π –ø—Ä–∞–π—Å-–ª–∏—Å—Ç –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è..." style="margin-top: 15px;"></textarea>
            </div>
            
            <div class="card">
                <h2><i class="fa-solid fa-database"></i> –î–æ–≤—ñ–¥–Ω–∏–∫ –ü–∞—Ä—Ñ—É–º—ñ–≤</h2>
                <div style="margin-bottom: 15px; background: var(--bg-input); padding: 15px; border-radius: 8px; border: 1px solid var(--border);">
                    <div class="grid-3-col" style="margin-bottom: 10px;">
                        <div><input type="text" id="adminPerfumeName" placeholder="–ù–∞–∑–≤–∞ –ø–∞—Ä—Ñ—É–º—É"></div>
                        <div><input type="number" id="adminBasePrice" placeholder="–°/–° (–≥—Ä–Ω/–º–ª)"></div>
                        <div><input type="text" id="adminBarcode" placeholder="–®—Ç—Ä–∏—Ö-–∫–æ–¥"></div> 
                    </div>
                    <div class="grid-2-col" style="margin-bottom: 10px;">
                        <input type="number" id="adminDiscountVolume" placeholder="–û–±'—î–º –¥–ª—è –∑–Ω–∏–∂–∫–∏ (–º–ª)" value="5">
                        <input type="number" id="adminDiscountPrice" placeholder="–°/–° –∑—ñ –∑–Ω–∏–∂–∫–æ—é (–≥—Ä–Ω/–º–ª)">
                    </div>
                    <button class="btn-success" onclick="addOrUpdatePerfume()"><i class="fa-solid fa-save"></i> –ó–±–µ—Ä–µ–≥—Ç–∏/–û–Ω–æ–≤–∏—Ç–∏</button>
                </div>
                <input type="text" id="perfumeSearchInput" onkeyup="renderPerfumeList()" placeholder="üîç –ü–æ—à—É–∫ —É –¥–æ–≤—ñ–¥–Ω–∏–∫—É..." style="margin-bottom: 10px;">
                <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                    <table id="perfume-list-table">
                        <thead><tr><th>–ù–∞–∑–≤–∞</th><th class="text-right">–°/–°</th><th class="text-right">–î—ñ—è</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3><i class="fa-solid fa-flask"></i> –§–ª–∞–∫–æ–Ω–∏ & –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h3>
                <div class="grid-2-col">
                    <div>
                        <label>–î–æ–¥–∞—Ç–∏ –§–ª–∞–∫–æ–Ω (–û–±'—î–º / –¶—ñ–Ω–∞)</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="number" id="adminFlaconVolume" placeholder="–º–ª">
                            <input type="number" id="adminFlaconCost" placeholder="–≥—Ä–Ω">
                            <button class="btn-success" style="width: auto;" onclick="addOrUpdateFlacon()"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                    <div>
                        <label>–î–æ–¥–∞—Ç–∏ –ù–∞—Ü—ñ–Ω–∫—É (–ù–∞–∑–≤–∞ / –ö–æ–µ—Ñ)</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="adminMarkupName" placeholder="–ù–∞–ø—Ä: VIP">
                            <input type="number" id="adminMarkupValue" placeholder="0.10">
                            <button class="btn-success" style="width: auto;" onclick="addOrUpdateMarkupPreset()"><i class="fa-solid fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fa-solid fa-database"></i> –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –î–∞–Ω–∏–º–∏</h3>
                <button class="btn-primary" onclick="exportDataToJSON()"><i class="fa-solid fa-download"></i> –ó—Ä–æ–±–∏—Ç–∏ –ë–µ–∫-–∞–ø (JSON)</button>
                <h4 style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px;">–í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –î–∞–Ω—ñ:</h4>
                <input type="file" id="importFileInput" accept=".json" style="margin-bottom: 10px;">
                <button class="btn-danger" onclick="importDataFromJSON()"><i class="fa-solid fa-upload"></i> –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –∑ –§–∞–π–ª—É</button>
                <h4 style="margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px;">–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è (Text):</h4>
                <button class="btn-warning" onclick="showSyncModal()"><i class="fa-solid fa-link"></i> –í—ñ–¥–∫—Ä–∏—Ç–∏ –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ</button>
            </div>
        </section>

        <section id="expenses" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-money-bill-wave"></i> –î–æ–¥–∞—Ç–∏ –í–∏—Ç—Ä–∞—Ç—É</h2>
                <div class="grid-2-col" style="margin-bottom: 15px;">
                    <div><label>–û–ø–∏—Å –≤–∏—Ç—Ä–∞—Ç–∏</label><input type="text" id="expenseDescription" placeholder="–ù–∞–ø—Ä: –ù–æ–≤–∞ –ü–æ—à—Ç–∞ –∑–∞ —Ç–∏–∂–¥–µ–Ω—å"></div>
                    <div><label>–°—É–º–∞ (‚Ç¥)</label><input type="number" id="expenseAmount" placeholder="–ù–∞–ø—Ä: 150.50"></div>
                </div>
                <button class="btn-danger" onclick="addExpense()"><i class="fa-solid fa-minus-circle"></i> –ó–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –í–∏—Ç—Ä–∞—Ç—É</button>
                <div id="expenseListOutput" style="margin-top: 20px;"></div>
            </div>
        </section>

        <section id="calculator" class="content-section">
            <div class="card">
                <h2><i class="fa-solid fa-calculator"></i> –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Ü—ñ–Ω–∏</h2>
                <div class="grid-3-col" style="margin-bottom: 15px;">
                    <div><label>–ü–∞—Ä—Ñ—É–º</label><input type="text" id="calcPerfumeName" list="perfumeList"></div>
                    <div><label>–û–±'—î–º</label><select id="calcFlaconVolume"></select></div>
                    <div><label>–ù–∞—Ü—ñ–Ω–∫–∞</label><select id="calcMarkupTier"></select></div>
                </div>
                <button class="btn-primary" onclick="calculateRetailPrice()"><i class="fa-solid fa-search-dollar"></i> –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏</button>
                <div id="calculatorOutput" style="margin-top: 20px;"></div>
            </div>
        </section>

    </div>

    <div id="receiptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header no-print">
                <h3 style="margin:0;">–ß–µ–∫-–æ—Ä–¥–µ—Ä</h3>
                <button class="btn-sm" style="width:auto" onclick="closeReceiptModal()">‚úï</button>
            </div>
            <div class="modal-body" id="receiptContent"></div>
        </div>
    </div>

    <div id="syncModal" class="modal">
        <div class="modal-content">
            <div class="modal-header no-print">
                <h3 style="margin:0;">–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –î–∞–Ω–∏—Ö</h3>
                <button class="btn-sm" style="width:auto" onclick="closeSyncModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <p>–°–∫–æ–ø—ñ—é–π—Ç–µ —Ü–µ–π —Ç–µ–∫—Å—Ç –¥–ª—è –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–∞ —ñ–Ω—à–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó.</p>
                <textarea id="syncDataOutput" rows="15" readonly style="width: 100%; resize: none; font-size: 0.75rem;"></textarea>
                <button class="btn-success" style="margin-top: 10px;" onclick="copySyncData()"><i class="fa-solid fa-copy"></i> –ö–æ–ø—ñ—é–≤–∞—Ç–∏</button>
                <p style="margin-top: 20px; border-top: 1px dashed var(--border); padding-top: 15px;">**–ê–ë–û –í–°–¢–ê–í–ò–¢–ò –î–õ–Ø –Ü–ú–ü–û–†–¢–£:**</p>
                <textarea id="syncDataInput" rows="5" placeholder="–í—Å—Ç–∞–≤—Ç–µ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω—ñ –¥–∞–Ω—ñ —Å—é–¥–∏..." style="width: 100%; resize: none;"></textarea>
                <button class="btn-warning" style="margin-top: 10px;" onclick="importDataFromSync()"><i class="fa-solid fa-upload"></i> –í—ñ–¥–Ω–æ–≤–∏—Ç–∏</button>
            </div>
        </div>
    </div>

    <datalist id="perfumeList"></datalist>
    <datalist id="clientList"></datalist>

    <script>
        const CONFIG_KEYS = {
            PRICES: 'perfumePrices',
            FLACONS: 'flaconCosts',
            VOLUMES: 'flaconVolumes',
            MARKUPS: 'markupPresets',
            SOURCES: 'salesSources',
            TRANSACTIONS: 'transactions',
            EXPENSES: 'expenses',
            INVENTORY: 'perfumeStock',
            TASKS: 'userTasks',
            THEME: 'themePreference' 
        };

        // ==========================================
        //  –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –¢–ï–ö–°–¢–£ –ó–ê–ú–û–í–õ–ï–ù–ù–Ø
        // ==========================================
        const MY_PAYMENT_INFO = `üí≥ –û–ø–ª–∞—Ç–∞:
–ú–æ–Ω–æ–±–∞–Ω–∫: 4441 1111 5956 0303 (–í–∞—à–µ –ü—Ä—ñ–∑–≤–∏—â–µ)
`;

        const MY_DELIVERY_INFO = `- –û–ª—Ö –¥–æ—Å—Ç–∞–≤–∫–æ—é, –Ω–∞ –±—É–¥—å-—è–∫—É –ø–æ—à—Ç—É (–ö–æ–º—ñ—Å—ñ—è OLX: 3% + 35 –≥—Ä–Ω.);
- –ü–æ–≤–Ω–∞ –ø–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç—É, –±—É–¥—å —è–∫–∞ –ø–æ—à—Ç–∞ (–Ω–æ–≤–∞ –ø–æ—à—Ç–∞ —Ä–æ–±–ª—é –º—ñ–Ω—ñ–º–∞–ª—å–Ω—É —Ü—ñ–Ω—É
–¥–æ—Å—Ç–∞–≤–∫–∏);`;
        // ==========================================

        // --- GLOBAL DATA ---
        let PERFUME_PRICES = {};
        let FLACON_COSTS = { 5: 12, 10: 15, 15: 18, 20: 20, 30: 25, 50: 30, 100: 40 }; 
        let FLACON_VOLUMES = [5, 10, 15, 20, 30, 50, 100]; 
        let MARKUP_PRESETS = { '–ë–∞–∑–æ–≤–∞': 0.15, '–°—Ç–∞–Ω–¥–∞—Ä—Ç': 0.20, '–ü—Ä–µ–º—ñ—É–º': 0.25 }; 
        let SALES_SOURCES = ['Instagram', 'Viber', 'Telegram','OLX','–û—Å–æ–±–∏—Å—Ç–∞ –∑—É—Å—Ç—Ä—ñ—á'];
        let PERFUME_STOCK = {};
        let CURRENT_ORDER_LIST = []; 
        let TASKS = [];
        let IS_EDITING_ORDER = null; 

        // --- UTILITIES ---
        function saveToLocalStorage(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
        function getFromLocalStorage(key, defaultValue) { return JSON.parse(localStorage.getItem(key) || JSON.stringify(defaultValue)); }
        function showToast(message, type = 'primary') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fa-solid fa-info-circle"></i> ${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // --- THEME ---
        function initTheme() {
            if (localStorage.getItem(CONFIG_KEYS.THEME) === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-icon').className = 'fa-solid fa-sun';
            }
        }
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem(CONFIG_KEYS.THEME, isDark ? 'dark' : 'light');
            document.getElementById('theme-icon').className = isDark ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        }

        // --- DATA LOAD ---
        function loadPerfumePrices() { PERFUME_PRICES = getFromLocalStorage(CONFIG_KEYS.PRICES, {}); }
        function savePerfumePrices() { saveToLocalStorage(CONFIG_KEYS.PRICES, PERFUME_PRICES); }
        function loadFlaconData() {
            FLACON_COSTS = getFromLocalStorage(CONFIG_KEYS.FLACONS, FLACON_COSTS);
            FLACON_VOLUMES = getFromLocalStorage(CONFIG_KEYS.VOLUMES, FLACON_VOLUMES);
        }
        function loadMarkupPresets() { MARKUP_PRESETS = getFromLocalStorage(CONFIG_KEYS.MARKUPS, MARKUP_PRESETS); }
        function loadSalesSources() { SALES_SOURCES = getFromLocalStorage(CONFIG_KEYS.SOURCES, SALES_SOURCES); }
        function loadInventory() {
            PERFUME_STOCK = JSON.parse(localStorage.getItem(CONFIG_KEYS.INVENTORY) || '{}');
            Object.keys(PERFUME_PRICES).forEach(name => { if(PERFUME_STOCK[name] === undefined) PERFUME_STOCK[name] = 0; });
            Object.keys(PERFUME_STOCK).forEach(name => { if(PERFUME_PRICES[name] === undefined) delete PERFUME_STOCK[name]; });
            saveInventory();
        }
        function saveInventory() { saveToLocalStorage(CONFIG_KEYS.INVENTORY, PERFUME_STOCK); } 
        function getTasks() { return getFromLocalStorage(CONFIG_KEYS.TASKS, []); }
        function saveTasks(tasks) { saveToLocalStorage(CONFIG_KEYS.TASKS, tasks); }
        function getTransactions() { return getFromLocalStorage(CONFIG_KEYS.TRANSACTIONS, []); }
        function saveTransactions(txs) { saveToLocalStorage(CONFIG_KEYS.TRANSACTIONS, txs); }
        function getExpenses() { return getFromLocalStorage(CONFIG_KEYS.EXPENSES, []); }
        function saveExpenses(exps) { saveToLocalStorage(CONFIG_KEYS.EXPENSES, exps); }

        // --- PARSER LOGIC (FIXED) ---
        window.parseOrderText = function() {
            const text = document.getElementById('pasteArea').value;
            if(!text) return;

            // 1. Phone Finder (Fixed: handles spaces, dashes, parentheses)
            // Removes non-digit characters first to find the pattern
            const cleanPhoneText = text.replace(/[\s\-\(\)]/g, ''); 
            const phoneMatch = cleanPhoneText.match(/(?:\+38)?(0\d{9})/);
            if(phoneMatch) {
                document.getElementById('phoneSingle').value = phoneMatch[1] || phoneMatch[0];
            }

            // 2. Volume Finder (Fixed: handles numbers without 'ml' better)
            let foundVolume = null;
            
            // Check for strict "number + ml" first (e.g. "100ml")
            for (let v of FLACON_VOLUMES) {
                if (text.toLowerCase().includes(v + 'ml') || text.toLowerCase().includes(v + ' –º–ª')) {
                    foundVolume = v;
                    break;
                }
            }
            
            // If not found, check just numbers, but skip if it looks like phone or post office
            if (!foundVolume) {
                // simple regex to find isolated volume numbers like " 100 " 
                for (let v of FLACON_VOLUMES) {
                    const regex = new RegExp(`(^|\\s)${v}($|\\s)`);
                    if (regex.test(text)) {
                        foundVolume = v;
                        break;
                    }
                }
            }

            if(foundVolume) {
                document.getElementById('flaconVolume').value = foundVolume;
            }

            // 3. Perfume Name Finder (Fixed: Finds LONGEST match)
            // This prevents "Chanel" matching when text is "Chanel Chance"
            const textLower = text.toLowerCase();
            let foundPerfume = "";
            
            // Sort keys by length descending (longest first)
            const dbNames = Object.keys(PERFUME_PRICES).sort((a, b) => b.length - a.length);
            
            for (let name of dbNames) {
                if (textLower.includes(name.toLowerCase())) {
                    foundPerfume = name;
                    break; 
                }
            }
            
            if(foundPerfume) {
                document.getElementById('perfumeName').value = foundPerfume;
            }

            // 4. Try to find City and Post Office (Bonus)
            // City often starts with capital letter, Post Office usually near "‚Ññ" or "–≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è"
            const officeMatch = text.match(/(?:‚Ññ|–≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è|–≤—ñ–¥)\.?\s*(\d+)/i);
            if(officeMatch) {
                document.getElementById('postOfficeSingle').value = officeMatch[1];
            }
            
            // Simple city guess (Kyiv, Odessa, Lviv, Dnipro, Kharkiv)
            const commonCities = ["–ö–∏—ó–≤", "–õ—å–≤—ñ–≤", "–û–¥–µ—Å–∞", "–î–Ω—ñ–ø—Ä–æ", "–•–∞—Ä–∫—ñ–≤", "–ó–∞–ø–æ—Ä—ñ–∂–∂—è"];
            for (let city of commonCities) {
                if (text.includes(city)) {
                    document.getElementById('citySingle').value = city;
                    break;
                }
            }

            showToast("üîç –¢–µ–∫—Å—Ç –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω–æ!", "success");
        }

        // --- TASK LOGIC ---
        function addTask(description, type, relatedId, clientName, phone, city, postOffice, fullName, comments) {
            const tasks = getTasks();
            tasks.push({
                id: Date.now() + Math.random(),
                timestamp: Date.now(),
                description: description,
                type: type,
                relatedId: relatedId,
                clientName: clientName,
                isCompleted: false,
                phone: phone || '---',
                city: city || '---',
                postOffice: postOffice || '---',
                fullName: fullName || clientName || '---',
                comments: comments || '---'
            });
            saveTasks(tasks);
            showToast("‚úÖ –ó–∞–≤–¥–∞–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ!", "success");
        }
        window.deleteTaskByRelatedId = function(relatedId) {
            saveTasks(getTasks().filter(t => t.relatedId !== relatedId));
        }
        window.completeTask = function(id) {
            const tasks = getTasks();
            const task = tasks.find(t => t.id === id);
            if (task) { task.isCompleted = true; saveTasks(tasks); renderTasks(); showToast("‚úÖ –í–∏–∫–æ–Ω–∞–Ω–æ!", "success"); }
        }
        window.deleteTask = function(id) {
            saveTasks(getTasks().filter(t => t.id !== id));
            renderTasks();
            showToast("üóëÔ∏è –í–∏–¥–∞–ª–µ–Ω–æ.", "error");
        }

        // --- CALC LOGIC ---
        function calculateCost(perfumeName, volume, markupTier) {
            const pData = PERFUME_PRICES[perfumeName];
            const flaconCost = FLACON_COSTS[volume] || 0;
            const markup = MARKUP_PRESETS[markupTier] || MARKUP_PRESETS['–°—Ç–∞–Ω–¥–∞—Ä—Ç'];
            if (!pData) return null;
            let costPerML = pData.basePrice;
            if (volume >= pData.discountVolume && pData.discountPrice) costPerML = pData.discountPrice;
            const perfumeCostTotal = volume * costPerML;
            const costTotal = perfumeCostTotal + flaconCost;
            const profit = costTotal * markup;
            const revenue = costTotal + profit;
            return { costTotal, profit, revenue, flaconCost, perfumeCostTotal };
        }

        // --- INVENTORY ---
        window.addStock = function() {
            const name = document.getElementById('inventoryPerfumeName').value.trim();
            const volume = parseFloat(document.getElementById('inventoryVolume').value);
            if (!name || isNaN(volume) || volume === 0) return;
            if (!PERFUME_PRICES[name]) { showToast("–°–ø–æ—á–∞—Ç–∫—É –¥–æ–¥–∞–π—Ç–µ –ø–∞—Ä—Ñ—É–º —É –¥–æ–≤—ñ–¥–Ω–∏–∫!", "error"); return; }
            PERFUME_STOCK[name] = (PERFUME_STOCK[name] || 0) + volume;
            saveInventory(); renderInventoryList(); updateDashboard();
            document.getElementById('inventoryPerfumeName').value = '';
            document.getElementById('inventoryVolume').value = '';
            showToast(`–°–∫–ª–∞–¥ –æ–Ω–æ–≤–ª–µ–Ω–æ: ${name}`, "success");
        }
        window.scanBarcodeForStock = function(barcodeValue) {
            if (!barcodeValue) return;
            const barcodeToFind = barcodeValue.trim();
            let perfumeName = null;
            for (const name in PERFUME_PRICES) {
                if (PERFUME_PRICES[name].barcode === barcodeToFind) { perfumeName = name; break; }
            }
            if (perfumeName) {
                PERFUME_STOCK[perfumeName] = (PERFUME_STOCK[perfumeName] || 0) + 500;
                saveInventory(); renderInventoryList(); updateDashboard(); 
                showToast(`‚úÖ ${perfumeName} (+500 –º–ª) –¥–æ–¥–∞–Ω–æ!`, "success");
            } else {
                showToast(`‚ö†Ô∏è –®—Ç—Ä–∏—Ö-–∫–æ–¥ ${barcodeToFind} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.`, "error");
                document.getElementById('inventoryPerfumeName').value = `Code: ${barcodeToFind}`;
                document.getElementById('inventoryVolume').value = 500;
            }
        }

        // --- ADMIN ---
        window.addOrUpdatePerfume = function() {
            const name = document.getElementById('adminPerfumeName').value.trim();
            const basePrice = document.getElementById('adminBasePrice').value.trim();
            const discountVolume = document.getElementById('adminDiscountVolume').value.trim();
            const discountPrice = document.getElementById('adminDiscountPrice').value.trim();
            const barcode = document.getElementById('adminBarcode').value.trim();
            if (!name || !basePrice) { showToast("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –Ω–∞–∑–≤—É —Ç–∞ —Ü—ñ–Ω—É", "error"); return; }
            PERFUME_PRICES[name] = {
                basePrice: parseFloat(basePrice),
                discountVolume: parseFloat(discountVolume) || 5,
                discountPrice: parseFloat(discountPrice) || null,
                barcode: barcode || null
            };
            if (PERFUME_STOCK[name] === undefined) PERFUME_STOCK[name] = 0;
            savePerfumePrices(); saveInventory(); renderPerfumeList(); populateFormOptions();
            showToast(`–ó–±–µ—Ä–µ–∂–µ–Ω–æ: ${name}`, "success");
            document.getElementById('adminPerfumeName').value = '';
            document.getElementById('adminBasePrice').value = '';
            document.getElementById('adminBarcode').value = ''; 
        }
        window.editPerfume = function(name) {
            const pData = PERFUME_PRICES[name];
            if (!pData) return;
            document.getElementById('adminPerfumeName').value = name;
            document.getElementById('adminBasePrice').value = pData.basePrice;
            document.getElementById('adminDiscountVolume').value = pData.discountVolume || 5;
            document.getElementById('adminDiscountPrice').value = pData.discountPrice || '';
            document.getElementById('adminBarcode').value = pData.barcode || '';
            document.getElementById('adminPerfumeName').focus();
        }
        window.renderPerfumeList = function() {
            const tbody = document.getElementById('perfume-list-table').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            const search = document.getElementById('perfumeSearchInput').value.toLowerCase();
            Object.keys(PERFUME_PRICES).sort().forEach(name => {
                const pData = PERFUME_PRICES[name];
                if (search && !name.toLowerCase().includes(search) && (!pData.barcode || !pData.barcode.includes(search))) return;
                const barcodeDisplay = pData.barcode ? `<span style="font-size:0.75rem; color:var(--text-muted); display:block;">–ö–æ–¥: ${pData.barcode}</span>` : '';
                tbody.innerHTML += `<tr><td><span class="text-bold">${name}</span>${barcodeDisplay}</td><td class="text-right">${pData.basePrice.toFixed(2)} ‚Ç¥</td><td class="text-right"><button class="btn-sm btn-warning" onclick="editPerfume('${name.replace(/'/g, "\\'")}')"><i class="fa-solid fa-edit"></i></button> <button class="btn-sm btn-danger" onclick="deletePerfume('${name.replace(/'/g, "\\'")}')"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
        }
        window.deletePerfume = function(name) {
            if(confirm('–í–∏–¥–∞–ª–∏—Ç–∏?')) { delete PERFUME_PRICES[name]; delete PERFUME_STOCK[name]; savePerfumePrices(); saveInventory(); renderPerfumeList(); renderInventoryList(); populateFormOptions(); }
        }
        window.renderInventoryList = function() {
            const tbody = document.getElementById('inventory-list-table').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            let lowStockCount = 0;
            Object.keys(PERFUME_STOCK).sort().forEach(name => {
                const stock = PERFUME_STOCK[name];
                if (stock <= 100) lowStockCount++;
                tbody.innerHTML += `<tr><td>${name}</td><td class="text-right" ${stock <= 100 ? 'style="color:var(--danger);font-weight:bold;"' : ''}>${stock} –º–ª</td><td class="text-right"><button class="btn-sm btn-danger" onclick="PERFUME_STOCK['${name.replace(/'/g, "\\'")}']=0;saveInventory();renderInventoryList();updateDashboard();"><i class="fa-solid fa-trash"></i></button></td></tr>`;
            });
            const dashLowStock = document.getElementById('dash-low-stock-count-value');
            if(dashLowStock) dashLowStock.textContent = lowStockCount;
        }

        // --- NAVIGATION ---
        function showSection(sectionId, element) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            if (element) { document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active')); element.classList.add('active'); }
            if(sectionId === 'multi-calculator') renderOrderList();
            if(sectionId === 'transactions') renderTransactionHistory();
            if(sectionId === 'admin-panel') { renderPerfumeList(); renderInventoryList(); }
            if(sectionId === 'expenses') renderExpenseList();
            if(sectionId === 'dashboard') updateDashboard();
            if(sectionId === 'tasks') renderTasks();
        }

        function populateFormOptions() {
            const markupSelects = document.querySelectorAll('#saleMarkupTierSingle, #saleMarkupTierOrder, #calcMarkupTier, #priceListMarkup');
            const sourceSelects = document.querySelectorAll('#saleSourceSingle, #saleSourceOrder, #historyFilterSource');
            const flaconSelects = document.querySelectorAll('#flaconVolume, #orderFlaconVolume, #calcFlaconVolume');
            markupSelects.forEach(s => s.innerHTML = '');
            sourceSelects.forEach(s => s.innerHTML = '<option value="">–í—Å—ñ</option>'); 
            flaconSelects.forEach(s => s.innerHTML = '');
            Object.keys(MARKUP_PRESETS).forEach(name => { markupSelects.forEach(s => { const option = document.createElement('option'); option.value = name; option.textContent = `${name} (+${(MARKUP_PRESETS[name] * 100).toFixed(0)}%)`; s.appendChild(option); }); });
            FLACON_VOLUMES.sort((a, b) => a - b).forEach(vol => { flaconSelects.forEach(s => { const option = document.createElement('option'); option.value = vol; option.textContent = `${vol} –º–ª (${FLACON_COSTS[vol] || 0} –≥—Ä–Ω)`; s.appendChild(option); }); });
            SALES_SOURCES.forEach(source => { sourceSelects.forEach(s => { const option = document.createElement('option'); option.value = source; option.textContent = source; s.appendChild(option); }); });
            const perfumeList = document.getElementById('perfumeList'); perfumeList.innerHTML = '';
            Object.keys(PERFUME_PRICES).sort().forEach(name => { const option = document.createElement('option'); option.value = name; perfumeList.appendChild(option); });
            const clientList = document.getElementById('clientList'); clientList.innerHTML = '';
            const clients = new Set(getTransactions().map(t => t.clientName).filter(Boolean));
            clients.forEach(name => { const option = document.createElement('option'); option.value = name; clientList.appendChild(option); });
        }

        // --- ORDER ACTIONS ---
        window.addSale = function() {
            const name = document.getElementById('perfumeName').value.trim();
            const volume = parseFloat(document.getElementById('flaconVolume').value);
            const markupTier = document.getElementById('saleMarkupTierSingle').value;
            const source = document.getElementById('saleSourceSingle').value;
            const client = document.getElementById('clientNameSingle').value.trim() || '–ì—ñ—Å—Ç—å';
            const phone = document.getElementById('phoneSingle').value.trim();
            const fullName = document.getElementById('fullNameSingle').value.trim();
            const city = document.getElementById('citySingle').value.trim();
            const postOffice = document.getElementById('postOfficeSingle').value.trim();
            const comments = document.getElementById('commentsSingle').value.trim();
            if (!name || !volume || !source) { showToast("–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –ø–æ–ª—è!", "error"); return; }
            const calc = calculateCost(name, volume, markupTier);
            if (!calc) { showToast("–ü–∞—Ä—Ñ—É–º –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!", "error"); return; }
            const tx = {
                id: Date.now(), timestamp: Date.now(), clientName: client, source: source, markupTier: markupTier, perfumeName: name, quantityML: volume,
                revenue: calc.revenue, profit: calc.profit, costTotal: calc.costTotal
            };
            const txs = getTransactions(); txs.push(tx); saveTransactions(txs);
            PERFUME_STOCK[name] = (PERFUME_STOCK[name] || 0) - volume; saveInventory();
            addTask(`–ü—Ä–æ–¥–∞–∂: ${name} (${volume} –º–ª)`, 'sale', tx.id, client, phone, city, postOffice, fullName, comments);
            showToast(`–ü—Ä–æ–¥–∞–Ω–æ! –ü—Ä–∏–±—É—Ç–æ–∫: ${calc.profit.toFixed(0)} ‚Ç¥`, "success");
            document.getElementById('perfumeName').value = ''; updateDashboard();
        }

        window.addItemToOrder = function() {
            const name = document.getElementById('orderPerfumeName').value.trim();
            const volume = parseFloat(document.getElementById('orderFlaconVolume').value);
            const markup = document.getElementById('saleMarkupTierOrder').value;
            if (!name || !volume) return;
            const calc = calculateCost(name, volume, markup);
            if (!calc) return;
            CURRENT_ORDER_LIST.push({ ...calc, name: name, vol: volume, markup: markup });
            renderOrderList(); document.getElementById('orderPerfumeName').value = '';
        }
        window.removeItemFromOrder = function(index) { CURRENT_ORDER_LIST.splice(index, 1); renderOrderList(); }

        window.renderOrderList = function() {
            const tbody = document.getElementById('order-list-table').getElementsByTagName('tbody')[0];
            const totalDiv = document.getElementById('orderTotalSection');
            const summaryText = document.getElementById('orderSummaryOutput');
            
            tbody.innerHTML = '';
            let totalRev = 0;

            CURRENT_ORDER_LIST.forEach((item, index) => {
                totalRev += item.revenue;
                tbody.innerHTML += `<tr><td>${item.name}</td><td class="text-right">${item.vol} –º–ª</td><td class="text-right">${item.revenue.toFixed(2)}</td><td class="text-right"><button class="btn-sm btn-danger" onclick="removeItemFromOrder(${index})"><i class="fa-solid fa-times"></i></button></td></tr>`;
            });

            totalDiv.textContent = `–†–∞–∑–æ–º: ${totalRev.toFixed(2)} ‚Ç¥`;
            
            // CLEAN ORDER TEXT
            if(CURRENT_ORDER_LIST.length > 0) {
                let text = "–í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:\n\n";
                CURRENT_ORDER_LIST.forEach((item, i) => { text += `${i+1}. ${item.name} (${item.vol} –º–ª) ‚Äî ${item.revenue.toFixed(0)} –≥—Ä–Ω\n`; });
                text += `\n${MY_DELIVERY_INFO}\n\n`;
                text += `${MY_PAYMENT_INFO}\n\n`;
                text += `–î–æ —Å–ø–ª–∞—Ç–∏: ${totalRev.toFixed(0)} –≥—Ä–Ω`;
                summaryText.value = text;
            } else { summaryText.value = ''; }
        }

        window.clearOrder = function() { CURRENT_ORDER_LIST = []; renderOrderList(); IS_EDITING_ORDER = null; const btn = document.getElementById('processOrderBtn'); btn.innerHTML = '<i class="fa-solid fa-cash-register"></i> –û—Ñ–æ—Ä–º–∏—Ç–∏'; btn.classList.remove('btn-warning'); btn.classList.add('btn-success'); }
        window.revertOrderStock = function(orderId) {
            const txsToRevert = getTransactions().filter(t => t.orderId === orderId);
            let totalVolume = {};
            txsToRevert.forEach(item => { totalVolume[item.perfumeName] = (totalVolume[item.perfumeName] || 0) + item.quantityML; });
            for (const name in totalVolume) { PERFUME_STOCK[name] = (PERFUME_STOCK[name] || 0) + totalVolume[name]; }
            saveInventory();
        }
        window.deleteOrder = function(orderId, showToastMessage = true) {
            if(showToastMessage && !confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è?`)) return;
            revertOrderStock(orderId);
            saveTransactions(getTransactions().filter(t => t.orderId !== orderId));
            deleteTaskByRelatedId(orderId); 
            if (showToastMessage) showToast(`–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ.`, "error");
            renderTransactionHistory(); updateDashboard();
        }
        window.startEditOrder = function(orderId) {
            const txs = getTransactions().filter(t => t.orderId === orderId);
            if (txs.length === 0) return;
            IS_EDITING_ORDER = orderId; CURRENT_ORDER_LIST.length = 0;
            txs.forEach(t => { const calc = calculateCost(t.perfumeName, t.quantityML, t.markupTier); if (calc) CURRENT_ORDER_LIST.push({ ...calc, name: t.perfumeName, vol: t.quantityML, markup: t.markupTier }); });
            const first = txs[0];
            document.getElementById('clientNameOrder').value = first.clientName || '';
            document.getElementById('saleSourceOrder').value = first.source || '';
            document.getElementById('ttnNumberOrder').value = first.ttnNumber || '';
            const task = getTasks().find(t => t.relatedId === orderId);
            if (task) {
                document.getElementById('phoneOrder').value = task.phone;
                document.getElementById('fullNameOrder').value = task.fullName;
                document.getElementById('cityOrder').value = task.city;
                document.getElementById('postOfficeOrder').value = task.postOffice;
            }
            renderOrderList();
            const btn = document.getElementById('processOrderBtn');
            btn.innerHTML = '<i class="fa-solid fa-save"></i> –ó–±–µ—Ä–µ–≥—Ç–∏';
            btn.classList.remove('btn-success'); btn.classList.add('btn-warning');
            showSection('multi-calculator', document.querySelector('.navbar-links .nav-btn:nth-child(3)'));
        }
        window.processOrder = function() {
            if(CURRENT_ORDER_LIST.length === 0) return;
            const client = document.getElementById('clientNameOrder').value.trim() || '–ö–ª—ñ—î–Ω—Ç';
            const markup = document.getElementById('saleMarkupTierOrder').value;
            const source = document.getElementById('saleSourceOrder').value;
            const ttn = document.getElementById('ttnNumberOrder').value.trim() || null;
            const phone = document.getElementById('phoneOrder').value.trim();
            const fullName = document.getElementById('fullNameOrder').value.trim();
            const city = document.getElementById('cityOrder').value.trim();
            const postOffice = document.getElementById('postOfficeOrder').value.trim();
            const comments = document.getElementById('commentsOrder').value.trim();
            if(!source) { showToast("–û–±–µ—Ä—ñ—Ç—å –¥–∂–µ—Ä–µ–ª–æ!", "error"); return; }
            if (IS_EDITING_ORDER) { deleteOrder(IS_EDITING_ORDER, false); IS_EDITING_ORDER = null; const btn = document.getElementById('processOrderBtn'); btn.innerHTML = '<i class="fa-solid fa-cash-register"></i> –û—Ñ–æ—Ä–º–∏—Ç–∏'; btn.classList.remove('btn-warning'); btn.classList.add('btn-success'); }
            const txs = getTransactions();
            const total = CURRENT_ORDER_LIST.reduce((acc, item) => acc + item.revenue, 0);
            const orderId = IS_EDITING_ORDER || Date.now(); 
            const newTransactions = CURRENT_ORDER_LIST.map(item => ({
                id: Date.now() + Math.random(), timestamp: Date.now(), clientName: client, source: source, markupTier: markup,
                perfumeName: item.name, quantityML: item.vol, revenue: item.revenue, profit: item.profit, costTotal: item.costTotal,
                ttnNumber: ttn, orderId: orderId 
            }));
            txs.push(...newTransactions); saveTransactions(txs);
            let totalVolume = {};
            CURRENT_ORDER_LIST.forEach(item => { totalVolume[item.name] = (totalVolume[item.name] || 0) + item.vol; });
            for (const name in totalVolume) { PERFUME_STOCK[name] = (PERFUME_STOCK[name] || 0) - totalVolume[name]; }
            saveInventory();
            const itemSummary = CURRENT_ORDER_LIST.map(item => `${item.name} (${item.vol}ml)`).join(', ');
            addTask(`–í—ñ–¥–ø—Ä–∞–≤–∫–∞: ${client} - ${itemSummary}`, 'order', orderId, client, phone, city, postOffice, fullName, comments);
            showToast(`‚úÖ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ!`, "success");
            showModalReceipt(CURRENT_ORDER_LIST, total, client, ttn); 
            clearOrder(); updateDashboard();
        }

        // --- DASHBOARD ---
        window.updateDashboard = function() {
            const today = new Date().toISOString().split('T')[0];
            const txs = getTransactions();
            const todayTxs = txs.filter(t => new Date(t.timestamp).toISOString().split('T')[0] === today);
            const rev = todayTxs.reduce((a,b) => a + b.revenue, 0);
            const prof = todayTxs.reduce((a,b) => a + b.profit, 0);
            document.getElementById('dash-revenue').textContent = rev.toFixed(0) + ' ‚Ç¥';
            document.getElementById('dash-profit').textContent = prof.toFixed(0) + ' ‚Ç¥';
            document.getElementById('dash-count').textContent = todayTxs.length;
            renderTopProducts(txs); 
        }
        function renderTopProducts(transactions) {
            const productStats = {};
            transactions.forEach(t => {
                if (!productStats[t.perfumeName]) productStats[t.perfumeName] = { vol: 0, revenue: 0 };
                productStats[t.perfumeName].vol += t.quantityML;
                productStats[t.perfumeName].revenue += t.revenue;
            });
            const sortedProducts = Object.entries(productStats).sort(([,a], [,b]) => b.vol - a.vol).slice(0, 5); 
            const tbody = document.getElementById('top-products-table').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';
            if (sortedProducts.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px;">–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö</td></tr>'; return; }
            sortedProducts.forEach(([name, data], index) => {
                let rankDisplay = index + 1;
                if (index === 0) rankDisplay = 'ü•á ' + rankDisplay;
                if (index === 1) rankDisplay = 'ü•à ' + rankDisplay;
                if (index === 2) rankDisplay = 'ü•â ' + rankDisplay;
                tbody.innerHTML += `<tr><td style="font-weight:bold;">${rankDisplay}</td><td>${name}</td><td class="text-right text-bold">${data.vol} –º–ª</td><td class="text-right text-success">${data.revenue.toFixed(0)} ‚Ç¥</td></tr>`;
            });
        }

        // --- HISTORY ---
        window.renderTransactionHistory = function() {
            const tbody = document.getElementById('transaction-history-table').getElementsByTagName('tbody')[0];
            const summary = document.getElementById('transactionSummary');
            tbody.innerHTML = '';
            const uniqueTransactions = {};
            getTransactions().forEach(t => { const key = t.orderId || t.id; if(!uniqueTransactions[key] || t.orderId) uniqueTransactions[key] = t; });
            const filteredTxs = Object.values(uniqueTransactions).filter(t => {
                const search = document.getElementById('transactionSearch').value.toLowerCase();
                const sourceFilter = document.getElementById('historyFilterSource').value;
                const dateFilter = document.getElementById('historyStartDate').value;
                if(search && !t.perfumeName.toLowerCase().includes(search) && !t.clientName.toLowerCase().includes(search)) return false;
                if(sourceFilter && t.source !== sourceFilter) return false;
                if(dateFilter && new Date(t.timestamp).toISOString().split('T')[0] !== dateFilter) return false;
                return true;
            });
            let totalRev = 0; let totalProf = 0;
            filteredTxs.sort((a, b) => b.timestamp - a.timestamp).forEach(t => {
                let displayItems = [t];
                if (t.orderId) displayItems = getTransactions().filter(tx => tx.orderId === t.orderId);
                const totalRevenue = displayItems.reduce((acc, item) => acc + (parseFloat(item.revenue) || 0), 0);
                const totalProfit = displayItems.reduce((acc, item) => acc + (parseFloat(item.profit) || 0), 0);
                totalRev += totalRevenue; totalProf += totalProfit;
                const infoText = t.orderId ? `–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è (${displayItems.length} –ø–æ–∑.)` : `${t.perfumeName} (${t.quantityML} –º–ª)`;
                const ttnDisplay = t.ttnNumber ? `<a href="https://novaposhta.ua/tracking/?cargo_key=${t.ttnNumber}" target="_blank">${t.ttnNumber}</a>` : '-';
                const deleteButton = t.orderId 
                    ? `<button class="btn-danger btn-sm" onclick="deleteOrder(${t.orderId})"><i class="fa-solid fa-trash"></i></button>` 
                    : `<button class="btn-danger btn-sm" onclick="deleteTx(${t.id})"><i class="fa-solid fa-trash"></i></button>`;
                const editButton = t.orderId ? `<button class="btn-warning btn-sm" onclick="startEditOrder(${t.orderId})"><i class="fa-solid fa-edit"></i></button>` : '';
                tbody.innerHTML += `<tr><td>${new Date(t.timestamp).toLocaleDateString()}</td><td>${t.clientName}</td><td>${t.source}</td><td>${ttnDisplay}</td><td>${infoText}</td><td class="text-right">${totalRevenue.toFixed(2)}</td><td class="text-right text-success">${totalProfit.toFixed(2)}</td><td class="text-right">${editButton} ${deleteButton}</td></tr>`;
            });
            summary.textContent = `–í—Å—å–æ–≥–æ: ${totalRev.toFixed(2)} ‚Ç¥ (–ü—Ä–∏–±—É—Ç–æ–∫: ${totalProf.toFixed(2)} ‚Ç¥)`;
        }
        window.deleteTx = function(id) {
            if(!confirm("–í–∏–¥–∞–ª–∏—Ç–∏?")) return;
            const tx = getTransactions().find(t => t.id === id);
            if(tx) { PERFUME_STOCK[tx.perfumeName] = (PERFUME_STOCK[tx.perfumeName] || 0) + tx.quantityML; saveInventory(); }
            saveTransactions(getTransactions().filter(t => t.id !== id));
            renderTransactionHistory(); updateDashboard();
        }

        window.renderTasks = function() {
            const container = document.getElementById('tasks-list-container');
            const tasks = getTasks().sort((a,b) => b.timestamp - a.timestamp);
            container.innerHTML = '';
            if (tasks.length === 0) { container.innerHTML = '<p style="text-align:center; color:var(--text-muted);">–ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å</p>'; return; }
            tasks.forEach(task => {
                const date = new Date(task.timestamp).toLocaleString();
                const statusClass = task.isCompleted ? 'completed' : '';
                const shippingInfo = `
                    <div style="margin-top:5px; font-size:0.85rem; background:var(--bg-card); padding:8px; border-radius:4px; border:1px solid var(--border);">
                        <div><i class="fa-solid fa-user"></i> ${task.fullName}</div>
                        <div><i class="fa-solid fa-phone"></i> ${task.phone}</div>
                        <div><i class="fa-solid fa-location-dot"></i> ${task.city}, ${task.postOffice}</div>
                        ${task.comments !== '---' && task.comments ? `<div class="task-comment"><i class="fa-solid fa-comment"></i> ${task.comments}</div>` : ''}
                    </div>
                `;
                container.innerHTML += `<div class="task-item ${statusClass}"><div class="task-header"><span class="task-title">${task.type === 'order' ? 'üì¶ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è' : 'üõçÔ∏è –ü—Ä–æ–¥–∞–∂'}</span><span style="font-size:0.8rem; color:var(--text-muted);">${date}</span></div><div class="task-details">${task.description} ${shippingInfo}</div><div style="margin-top: 10px; display: flex; gap: 10px;">${!task.isCompleted ? `<button class="btn-success btn-sm" onclick="completeTask(${task.id})">–í–∏–∫–æ–Ω–∞–Ω–æ</button>` : ''}<button class="btn-danger btn-sm" onclick="deleteTask(${task.id})"><i class="fa-solid fa-trash"></i></button></div></div>`;
            });
        }
        
        window.copyOrderSummary = function() { document.getElementById("orderSummaryOutput").select(); document.execCommand("copy"); showToast("–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!", "success"); }
        window.generateReport = function() {
            const start = document.getElementById('startDate').value; const end = document.getElementById('endDate').value; const output = document.getElementById('reportOutput');
            if(!start || !end) return;
            const txs = getTransactions().filter(t => { const d = new Date(t.timestamp).toISOString().split('T')[0]; return d >= start && d <= end; });
            const revenue = txs.reduce((a, b) => a + b.revenue, 0); const profit = txs.reduce((a, b) => a + b.profit, 0);
            const exps = getExpenses().filter(e => { const d = new Date(e.timestamp).toISOString().split('T')[0]; return d >= start && d <= end; });
            const totalExp = exps.reduce((a, b) => a + b.amount, 0);
            output.innerHTML = `<div style="background:var(--bg-input); padding:15px; border-radius:8px;"><p><strong>–í–∏—Ä—É—á–∫–∞:</strong> ${revenue.toFixed(2)} ‚Ç¥</p><p><strong>–í–∏—Ç—Ä–∞—Ç–∏:</strong> ${totalExp.toFixed(2)} ‚Ç¥</p><p style="font-size:1.2rem; color:var(--primary);"><strong>–ß–∏—Å—Ç–∏–π: ${(profit - totalExp).toFixed(2)} ‚Ç¥</strong></p></div>`;
        }
        window.addExpense = function() {
            const desc = document.getElementById('expenseDescription').value; const amount = parseFloat(document.getElementById('expenseAmount').value);
            if(!desc || !amount) return;
            const exps = getExpenses(); exps.push({ id: Date.now(), timestamp: Date.now(), description: desc, amount: amount });
            saveExpenses(exps); renderExpenseList();
            document.getElementById('expenseDescription').value = ''; document.getElementById('expenseAmount').value = '';
        }
        window.renderExpenseList = function() {
            const div = document.getElementById('expenseListOutput');
            const exps = getExpenses().sort((a,b) => b.timestamp - a.timestamp).slice(0, 5);
            div.innerHTML = exps.map(e => `<div style="display:flex; justify-content:space-between; border-bottom:1px solid var(--border); padding:5px 0;"><span>${e.description}</span><span style="font-weight:bold; color:var(--danger)">-${e.amount} ‚Ç¥</span></div>`).join('');
        }
        window.addOrUpdateFlacon = function() {
             const vol = parseFloat(document.getElementById('adminFlaconVolume').value); const cost = parseFloat(document.getElementById('adminFlaconCost').value);
             if(vol && cost) { FLACON_COSTS[vol] = cost; if(!FLACON_VOLUMES.includes(vol)) FLACON_VOLUMES.push(vol); saveToLocalStorage(CONFIG_KEYS.FLACONS, FLACON_COSTS); saveToLocalStorage(CONFIG_KEYS.VOLUMES, FLACON_VOLUMES); populateFormOptions(); showToast("–§–ª–∞–∫–æ–Ω –¥–æ–¥–∞–Ω–æ", "success"); }
        }
        window.addOrUpdateMarkupPreset = function() {
            const name = document.getElementById('adminMarkupName').value; const val = parseFloat(document.getElementById('adminMarkupValue').value);
            if(name && val) { MARKUP_PRESETS[name] = val; saveToLocalStorage(CONFIG_KEYS.MARKUPS, MARKUP_PRESETS); populateFormOptions(); showToast("–ù–∞—Ü—ñ–Ω–∫—É –¥–æ–¥–∞–Ω–æ", "success"); }
        }
        window.calculateRetailPrice = function() {
            const name = document.getElementById('calcPerfumeName').value; const vol = parseFloat(document.getElementById('calcFlaconVolume').value); const mark = document.getElementById('calcMarkupTier').value;
            const res = calculateCost(name, vol, mark);
            if(res) { document.getElementById('calculatorOutput').innerHTML = `<strong>–¶—ñ–Ω–∞: ${res.revenue.toFixed(0)} ‚Ç¥</strong>`; }
        }
        window.generatePriceList = function() {
            const markupKey = document.getElementById('priceListMarkup').value; if(!markupKey) return;
            let text = `üìÖ –ü—Ä–∞–π—Å-–ª–∏—Å—Ç (${new Date().toLocaleDateString()})\n\n`;
            Object.keys(PERFUME_PRICES).sort().forEach(name => {
                let line = `üîπ ${name}\n`;
                FLACON_VOLUMES.forEach(vol => { const cost = calculateCost(name, vol, markupKey); if(cost) line += `   ‚ñ´Ô∏è ${vol} –º–ª ‚Äî ${cost.revenue.toFixed(0)} –≥—Ä–Ω\n`; });
                text += line + "\n";
            });
            const output = document.getElementById('priceListOutput'); output.value = text; output.select(); document.execCommand("copy"); showToast("–ü—Ä–∞–π—Å —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!", "success");
        }
        window.showClientHistory = function() {
            const clientName = document.getElementById('clientSearchInput').value.trim().toLowerCase(); if(!clientName) return;
            const txs = getTransactions().filter(t => t.clientName.toLowerCase().includes(clientName));
            const tbody = document.getElementById('client-history-table').getElementsByTagName('tbody')[0]; tbody.innerHTML = '';
            let total = 0; txs.forEach(t => { total += t.revenue; tbody.innerHTML += `<tr><td>${new Date(t.timestamp).toLocaleDateString()}</td><td>${t.perfumeName} (${t.quantityML}ml)</td><td class="text-right">${t.revenue}</td><td class="text-right">${t.profit}</td></tr>`; });
            document.getElementById('clientCrmSummary').innerHTML = `<strong>–í—Å—å–æ–≥–æ –ø–æ–∫—É–ø–æ–∫: ${txs.length} | –°—É–º–∞: ${total} ‚Ç¥</strong>`;
        }

        // --- MODAL UTILS ---
        function generateReceiptHTML(orderItems, totalRounded, clientName, ttn = null) {
            const total = totalRounded.toFixed(2); const date = new Date().toLocaleDateString('uk-UA');
            const itemsHtml = orderItems.map((item, index) => `<p style="margin: 5px 0; display: flex; justify-content: space-between; font-size: 0.95rem;"><span>${index + 1}. ${item.name} (${item.vol} –º–ª)</span><span class="text-bold">${item.revenue.toFixed(2)} ‚Ç¥</span></p>`).join('');
            const ttnDisplay = ttn ? `<p style="margin: 10px 0; font-weight: 600;">üì¶ –¢–¢–ù: ${ttn}</p>` : '';
            return `<div style="max-width: 300px; margin: 0 auto; padding: 15px; border: 1px dashed var(--border); border-radius: 5px; font-family: monospace; color: var(--text-main);"><h3 style="text-align: center; margin-bottom: 5px; color: var(--primary);">PerfumeFlow</h3><p style="text-align: center; margin-bottom: 15px; border-bottom: 1px dashed var(--border); padding-bottom: 5px; font-size: 0.85rem;">–î–∞—Ç–∞: ${date} | –ö–ª—ñ—î–Ω—Ç: ${clientName}</p>${itemsHtml}${ttnDisplay}<div class="receipt-total">–î–æ —Å–ø–ª–∞—Ç–∏: ${total} ‚Ç¥</div><p style="text-align: center; margin-top: 20px; font-size: 0.9rem; color: var(--text-muted);" class="no-print">–î—è–∫—É—î–º–æ!</p><div class="no-print admin-buttons-group" style="margin-top: 20px; text-align: center; display: flex; gap: 10px;"><button onclick="window.print()" style="background-color: var(--secondary); flex-grow: 1; color: white; border: none; border-radius: 4px; padding: 8px;">üñ®Ô∏è –î—Ä—É–∫</button><button onclick="closeReceiptModal()" style="background-color: var(--text-muted); flex-grow: 1; color: white; border: none; border-radius: 4px; padding: 8px;">–ó–∞–∫—Ä–∏—Ç–∏</button></div></div>`;
        }
        function showModalReceipt(orderItems, totalRounded, clientName, ttn = null) {
            document.getElementById('receiptContent').innerHTML = generateReceiptHTML(orderItems, totalRounded, clientName, ttn);
            document.getElementById('receiptModal').classList.add('active');
        }
        window.closeReceiptModal = function() { document.getElementById('receiptModal').classList.remove('active'); }
        
        // --- SYNC / EXPORT ---
        window.showSyncModal = function() {
            const allData = {}; Object.values(CONFIG_KEYS).forEach(key => allData[key] = JSON.parse(localStorage.getItem(key) || 'null'));
            document.getElementById('syncDataOutput').value = JSON.stringify(allData); document.getElementById('syncModal').classList.add('active');
        }
        window.closeSyncModal = function() { document.getElementById('syncModal').classList.remove('active'); }
        window.copySyncData = function() { document.getElementById("syncDataOutput").select(); document.execCommand("copy"); showToast("–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!", "success"); }
        window.importDataFromSync = function() {
            try { const data = JSON.parse(document.getElementById('syncDataInput').value); if(confirm("–¶–µ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ –¥–∞–Ω—ñ! –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?")) { Object.keys(data).forEach(key => { if(data[key]) localStorage.setItem(key, JSON.stringify(data[key])); }); location.reload(); } } catch(e) { showToast("–ü–æ–º–∏–ª–∫–∞ —Ñ–æ—Ä–º–∞—Ç—É", "error"); }
        }
        window.exportDataToJSON = function() {
            const allData = {}; Object.values(CONFIG_KEYS).forEach(key => allData[key] = JSON.parse(localStorage.getItem(key) || 'null'));
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData));
            const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "backup_" + new Date().toISOString().slice(0,10) + ".json"); document.body.appendChild(dl); dl.click(); dl.remove();
        }
        window.importDataFromJSON = function() {
            const fileInput = document.getElementById('importFileInput'); if (!fileInput.files.length) return;
            const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); if(confirm("–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –¥–∞–Ω—ñ?")) { Object.keys(data).forEach(key => { if(data[key]) localStorage.setItem(key, JSON.stringify(data[key])); }); location.reload(); } } catch(err) { showToast("–ü–æ–º–∏–ª–∫–∞ —Ñ–∞–π–ª—É", "error"); } }; reader.readAsText(fileInput.files[0]);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initTheme(); loadPerfumePrices(); loadFlaconData(); loadMarkupPresets(); loadSalesSources(); loadInventory(); TASKS = getTasks(); 
            populateFormOptions(); renderExpenseList(); 
            const dashboardBtn = document.querySelector('.nav-btn'); showSection('dashboard', dashboardBtn);
            renderOrderList(); updateDashboard(); 
        });
    </script>
</body>
</html>
